<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Inference Triage</title>
    <link rel="stylesheet" href="/static/style.css">
</head>
<body>
    <div class="container">
        <header>
            <h1>Inference Triage</h1>
            <p>Help Ares understand you better.</p>
            <div style="margin-top: 10px;">
                <button id="btn-export" class="btn-small" style="background-color: #6200ea;">‚öóÔ∏è Export Spirit for Ares</button>
            </div>
            <div style="margin-top: 15px; border-top: 1px solid #ccc; padding-top: 10px;">
                <h3>Behavioral Archetypes</h3>
                <div style="display: flex; gap: 10px; justify-content: center;">
                    <span class="badge" style="background: #e3f2fd; color: #1565c0;">ü§ñ Bot Self</span>
                    <span class="badge" style="background: #e8f5e9; color: #2e7d32;">üí¨ Social Self</span>
                    <span class="badge" style="background: #fff3e0; color: #ef6c00;">üíº Professional Self</span>
                    <span class="badge" style="background: #f3e5f5; color: #7b1fa2;">üß† Curious Self</span>
                </div>
            </div>

            <div id="ingestion-section" style="margin-top: 20px; background: #fff; padding: 15px; border-radius: 8px;">
                <h3>Data Ingestion</h3>
                <div class="input-group">
                    <label>ChatGPT Export Path:</label>
                    <input type="text" id="path-chatgpt" placeholder="/Users/bryce/Downloads/package" style="width: 100%; margin-bottom: 5px;">
                    <button id="btn-ingest-chatgpt" class="btn-small">Load ChatGPT Data</button>
                </div>
                <div class="input-group" style="margin-top: 10px;">
                    <label>Safari History DB Path:</label>
                    <input type="text" id="path-safari" placeholder="/Users/bryce/Library/Safari/History.db" style="width: 100%; margin-bottom: 5px;">
                    <button id="btn-ingest-safari" class="btn-small">Load Safari History</button>
                </div>
                <div style="margin-top: 15px; text-align: center;">
                    <button id="btn-process-all" class="btn-small" style="background-color: #2e7d32; width: 100%;">üß† Process All Raw Data (Run Brain)</button>
                </div>
                <p id="ingest-status" style="font-size: 0.9em; color: #666; margin-top: 5px;"></p>
            </div>
        </header>

        <div id="card-container">
            <div id="inference-card" class="card">
                <div class="card-header">
                    <span id="source-badge" class="badge">Source</span>
                    <span id="confidence-badge" class="badge">Conf: 0.0</span>
                </div>

                <div class="card-body">
                    <h3>Inference:</h3>
                    <p id="inference-text" class="highlight-text">Loading...</p>

                    <hr>

                    <h4>Context / Evidence:</h4>
                    <p id="content-text" class="source-text">...</p>
                </div>

                <div class="card-actions">
                    <button id="btn-reject" class="btn btn-reject">‚úñ Reject</button>
                    <button id="btn-edit" class="btn btn-edit">‚úé Edit</button>
                    <button id="btn-approve" class="btn btn-approve">‚úî Approve</button>
                </div>

                <div id="edit-section" class="hidden">
                    <textarea id="edit-notes" placeholder="Add context or correct the inference..."></textarea>
                    <button id="btn-submit-edit" class="btn btn-small">Save & Approve</button>
                </div>
            </div>

            <div id="empty-state" class="hidden">
                <h2>All caught up!</h2>
                <p>No more pending inferences.</p>
            </div>
        </div>
    </div>
    <script src="/static/script.js"></script>
    <script>
        // Export Logic
        document.getElementById("btn-export").addEventListener("click", async () => {
            const btn = document.getElementById("btn-export");
            btn.textContent = "‚è≥ Distilling...";
            try {
                const response = await fetch("/api/export");
                if (response.ok) {
                    const blob = await response.blob();
                    const url = window.URL.createObjectURL(blob);
                    const a = document.createElement("a");
                    a.href = url;
                    a.download = "ares_consciousness.json";
                    document.body.appendChild(a);
                    a.click();
                    a.remove();
                    btn.textContent = "‚öóÔ∏è Export Spirit for Ares";
                } else {
                    alert("Failed to export.");
                    btn.textContent = "‚ùå Error";
                }
            } catch (e) {
                console.error(e);
                alert("Error exporting.");
                btn.textContent = "‚ùå Error";
            }
        });

        // Ingestion Logic
        async function triggerIngest(source, pathId, statusMsg) {
            const path = document.getElementById(pathId).value;
            if (!path) {
                alert("Please enter a path.");
                return;
            }

            const statusEl = document.getElementById("ingest-status");
            statusEl.textContent = `Loading ${source}...`;

            try {
                const response = await fetch(`/api/ingest/${source}`, {
                    method: "POST",
                    headers: {"Content-Type": "application/json"},
                    body: JSON.stringify({path: path})
                });
                const data = await response.json();
                if (response.ok) {
                    statusEl.textContent = `‚úÖ ${data.items_count} items loaded from ${source}.`;
                } else {
                    statusEl.textContent = `‚ùå Error: ${data.detail}`;
                }
            } catch (e) {
                statusEl.textContent = "‚ùå Network Error";
            }
        }

        document.getElementById("btn-ingest-chatgpt").addEventListener("click", () =>
            triggerIngest("chatgpt", "path-chatgpt", "ChatGPT"));

        document.getElementById("btn-ingest-safari").addEventListener("click", () =>
            triggerIngest("safari", "path-safari", "Safari"));

        // Process Logic
        document.getElementById("btn-process-all").addEventListener("click", async () => {
            const statusEl = document.getElementById("ingest-status");
            statusEl.textContent = "üß† Brain is processing raw data... (this may take a while)";
            try {
                const response = await fetch("/api/process", {method: "POST"});
                const data = await response.json();
                statusEl.textContent = `‚úÖ Processing complete. Generated ${data.inferences_generated} new inferences.`;
                // Reload page to show new inferences? or just fetchNext
                fetchInference();
            } catch (e) {
                statusEl.textContent = "‚ùå Brain Error";
            }
        });
    </script>
</body>
</html>
